# TODO: Ticket Code Signup & Customer Permissions

## Phase 1: Database Changes
- [x] 1.1 Create SQL migration file (migration_006_ticket_code_signup.sql)
  - Add `ticket_code` column to `tickets` table
  - Create `validate_ticket_code` RPC function
  - Create `join_organization_by_ticket` RPC function
  - Update RLS policies to prevent customers from editing tickets

## Phase 2: TypeScript Types Update
- [x] 2.1 Update `types/database.types.ts`
  - Add `ticket_code` to Ticket interface
  - Add ticket code signup types

## Phase 3: Frontend Updates
- [x] 3.1 Update `app/(auth)/signup/page.tsx`
  - Add ticket code option for customer signup
  - Add validation for ticket codes
  - Add RPC call to join via ticket code

- [x] 3.2 Update `app/(dashboard)/dashboard/tickets/[id]/ticket-detail-actions.tsx`
  - Hide edit actions (status/priority/assign) for customers (requester role)

- [x] 3.3 Update `app/(dashboard)/dashboard/tickets/new/page.tsx`
  - Generate ticket code on ticket creation (auto-generated by DB trigger)
  - Display ticket code after creation
  - **FIX**: Properly fetch ticket_code if not returned from insert

- [x] 3.4 Update `app/(dashboard)/dashboard/tickets/[id]/page.tsx`
  - Add read-only notice for customers
  - Display ticket code in details section
  - **FIX**: Add ticket_code prominently in header with copy functionality
  - **NEW**: Create `ticket-code-card.tsx` component with copy button

- [x] 3.5 Update `app/(dashboard)/dashboard/tickets/page.tsx`
  - Add ticket_code to Ticket type
  - Display ticket code column for admins/owners

## Phase 4: Testing & Verification
- [ ] 4.1 Run the SQL migration in Supabase SQL Editor
- [ ] 4.2 Run `migration_007_fix_tickets_visibility.sql` to fix ticket visibility
- [ ] 4.3 Test customer signup with ticket code
- [ ] 4.4 Verify customers cannot edit tickets
- [ ] 4.5 Verify owners/employees can edit tickets
- [ ] 4.6 Verify ticket code is displayed after ticket creation
- [ ] 4.7 Verify ticket code is visible in ticket detail header

## New Migration for Fixing Issues
- Created `migration_007_fix_tickets_visibility.sql` to:
  - Add ticket_code to existing tickets that don't have one
  - Fix RLS policies for tickets visibility
  - Simplify policies to ensure tickets show up correctly


---

## Implementation Notes

### Ticket Code Flow:
1. Customer obtains a ticket code (e.g., from a receipt, email, or support agent)
2. Customer selects "Customer" signup type
3. Customer enters ticket code instead of invitation code
4. System validates ticket code and creates account with access to the organization

### Customer Permissions:
- ✅ View tickets they created
- ✅ Create new tickets
- ✅ Add comments to their tickets
- ❌ Cannot edit ticket status
- ❌ Cannot edit ticket priority
- ❌ Cannot reassign tickets
- ❌ Cannot edit ticket title/description after creation

### Owner/Employee Permissions:
- ✅ All customer permissions
- ✅ Edit any ticket (status, priority, assignment)
- ✅ View all tickets in organization
- ✅ Manage team invitations

